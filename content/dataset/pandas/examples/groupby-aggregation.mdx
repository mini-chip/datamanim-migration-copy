# Pandas 예제문제 2 - GroupBy와 집계

## 문제 설명

GroupBy 연산을 활용하여 데이터를 그룹별로 집계하고 분석하는 방법을 학습하시오.

## 데이터 준비

```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# 판매 데이터 생성
np.random.seed(42)
n = 500

# 제품 카테고리와 지역 정의
categories = ['전자제품', '의류', '식품', '가구', '도서']
regions = ['서울', '부산', '대구', '인천', '광주']
sales_reps = [f'영업사원{i+1}' for i in range(20)]

data = {
    'order_date': pd.date_range('2023-01-01', periods=n, freq='D')[:n],
    'category': np.random.choice(categories, n),
    'region': np.random.choice(regions, n),
    'sales_rep': np.random.choice(sales_reps, n),
    'quantity': np.random.randint(1, 100, n),
    'unit_price': np.random.uniform(10, 1000, n).round(2),
    'customer_type': np.random.choice(['신규', '기존'], n, p=[0.3, 0.7])
}

# 총 매출액 계산
data['total_sales'] = data['quantity'] * data['unit_price']

df = pd.DataFrame(data)
df['month'] = df['order_date'].dt.month
df['quarter'] = df['order_date'].dt.quarter

print("데이터 기본정보:")
print(df.head())
print(f"\n데이터 크기: {df.shape}")
print(f"\n컬럼 정보:")
print(df.dtypes)
```

## 문제 1: 기본 GroupBy 연산

**Q1-1.** 카테고리별 총 매출액과 평균 매출액을 계산하시오.

<CollapsibleCodeCell language="python" defaultCollapsed={true}>
```python
# 카테고리별 집계
category_stats = df.groupby('category')['total_sales'].agg(['sum', 'mean', 'count'])
category_stats.columns = ['총매출액', '평균매출액', '주문건수']
category_stats = category_stats.round(2).sort_values('총매출액', ascending=False)

print("카테고리별 매출 분석:")
print(category_stats)

# 시각화
plt.figure(figsize=(12, 5))

plt.subplot(1, 2, 1)
category_stats['총매출액'].plot(kind='bar', color='skyblue')
plt.title('카테고리별 총 매출액')
plt.xlabel('카테고리')
plt.ylabel('매출액')
plt.xticks(rotation=45)
plt.grid(True, alpha=0.3)

plt.subplot(1, 2, 2)
category_stats['평균매출액'].plot(kind='bar', color='lightcoral')
plt.title('카테고리별 평균 매출액')
plt.xlabel('카테고리')
plt.ylabel('평균 매출액')
plt.xticks(rotation=45)
plt.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()

# 매출 비중 계산
category_stats['매출비중(%)'] = (category_stats['총매출액'] / category_stats['총매출액'].sum() * 100).round(1)
print(f"\n카테고리별 매출 비중:")
print(category_stats[['총매출액', '매출비중(%)']])
```
</CollapsibleCodeCell>

**Q1-2.** 지역별 매출 현황을 분석하시오.

<CollapsibleCodeCell language="python" defaultCollapsed={true}>
```python
# 지역별 상세 집계
region_analysis = df.groupby('region').agg({
    'total_sales': ['sum', 'mean', 'count'],
    'quantity': 'sum',
    'unit_price': 'mean'
}).round(2)

# 컬럼명 정리
region_analysis.columns = ['총매출액', '평균매출액', '주문건수', '총판매량', '평균단가']
region_analysis = region_analysis.sort_values('총매출액', ascending=False)

print("지역별 매출 분석:")
print(region_analysis)

# 지역별 고객 유형 분포
region_customer = pd.crosstab(df['region'], df['customer_type'], normalize='index') * 100
print(f"\n지역별 고객 유형 분포 (%):")
print(region_customer.round(1))

# 시각화
fig, axes = plt.subplots(2, 2, figsize=(15, 10))

# 지역별 총 매출액
region_analysis['총매출액'].plot(kind='bar', ax=axes[0,0], color='green')
axes[0,0].set_title('지역별 총 매출액')
axes[0,0].set_xlabel('지역')
axes[0,0].tick_params(axis='x', rotation=45)

# 지역별 주문건수
region_analysis['주문건수'].plot(kind='bar', ax=axes[0,1], color='orange')
axes[0,1].set_title('지역별 주문건수')
axes[0,1].set_xlabel('지역')
axes[0,1].tick_params(axis='x', rotation=45)

# 지역별 평균 단가
region_analysis['평균단가'].plot(kind='bar', ax=axes[1,0], color='purple')
axes[1,0].set_title('지역별 평균 단가')
axes[1,0].set_xlabel('지역')
axes[1,0].tick_params(axis='x', rotation=45)

# 고객 유형 분포 히트맵
sns.heatmap(region_customer, annot=True, fmt='.1f', ax=axes[1,1], cmap='Blues')
axes[1,1].set_title('지역별 고객 유형 분포 (%)')

plt.tight_layout()
plt.show()
```
</CollapsibleCodeCell>

## 문제 2: 다중 그룹화

**Q2-1.** 카테고리별, 지역별 매출을 동시에 분석하시오.

<CollapsibleCodeCell language="python" defaultCollapsed={true}>
```python
# 다중 그룹화
multi_group = df.groupby(['category', 'region'])['total_sales'].agg(['sum', 'mean', 'count'])
multi_group.columns = ['총매출액', '평균매출액', '주문건수']
multi_group = multi_group.round(2)

print("카테고리별, 지역별 매출 분석:")
print(multi_group.head(10))

# 피벗 테이블로 변환
pivot_sales = df.pivot_table(values='total_sales',
                            index='category',
                            columns='region',
                            aggfunc='sum',
                            fill_value=0).round(2)

print(f"\n카테고리-지역 매출 피벗 테이블:")
print(pivot_sales)

# 히트맵으로 시각화
plt.figure(figsize=(10, 6))
sns.heatmap(pivot_sales, annot=True, fmt='.0f', cmap='YlOrRd', cbar_kws={'label': '매출액'})
plt.title('카테고리별, 지역별 매출 히트맵')
plt.xlabel('지역')
plt.ylabel('카테고리')
plt.show()

# 각 카테고리에서 가장 높은 매출을 기록한 지역
best_regions = pivot_sales.idxmax(axis=1)
print(f"\n카테고리별 최고 매출 지역:")
for category, region in best_regions.items():
    sales = pivot_sales.loc[category, region]
    print(f"{category}: {region} ({sales:,.0f}원)")
```
</CollapsibleCodeCell>

## 문제 3: 시간별 집계

**Q3-1.** 월별, 분기별 매출 추이를 분석하시오.

<CollapsibleCodeCell language="python" defaultCollapsed={true}>
```python
# 월별 매출 분석
monthly_sales = df.groupby('month').agg({
    'total_sales': ['sum', 'mean'],
    'quantity': 'sum',
    'order_date': 'count'
}).round(2)

monthly_sales.columns = ['총매출액', '평균매출액', '총판매량', '주문건수']
print("월별 매출 분석:")
print(monthly_sales)

# 분기별 매출 분석
quarterly_sales = df.groupby('quarter').agg({
    'total_sales': ['sum', 'mean'],
    'quantity': 'sum'
}).round(2)

quarterly_sales.columns = ['총매출액', '평균매출액', '총판매량']
print(f"\n분기별 매출 분석:")
print(quarterly_sales)

# 시각화
fig, axes = plt.subplots(2, 2, figsize=(15, 10))

# 월별 총 매출액
monthly_sales['총매출액'].plot(kind='line', marker='o', ax=axes[0,0], color='blue')
axes[0,0].set_title('월별 총 매출액 추이')
axes[0,0].set_xlabel('월')
axes[0,0].set_ylabel('매출액')
axes[0,0].grid(True, alpha=0.3)

# 월별 주문건수
monthly_sales['주문건수'].plot(kind='bar', ax=axes[0,1], color='orange')
axes[0,1].set_title('월별 주문건수')
axes[0,1].set_xlabel('월')
axes[0,1].set_ylabel('주문건수')

# 분기별 매출액
quarterly_sales['총매출액'].plot(kind='bar', ax=axes[1,0], color='green')
axes[1,0].set_title('분기별 총 매출액')
axes[1,0].set_xlabel('분기')
axes[1,0].set_ylabel('매출액')

# 월별 평균 매출액
monthly_sales['평균매출액'].plot(kind='line', marker='s', ax=axes[1,1], color='red')
axes[1,1].set_title('월별 평균 매출액 추이')
axes[1,1].set_xlabel('월')
axes[1,1].set_ylabel('평균 매출액')
axes[1,1].grid(True, alpha=0.3)

plt.tight_layout()
plt.show()

# 성장률 계산
monthly_sales['전월대비성장률(%)'] = monthly_sales['총매출액'].pct_change() * 100
print(f"\n월별 매출 성장률:")
print(monthly_sales[['총매출액', '전월대비성장률(%)']].round(1))
```
</CollapsibleCodeCell>

## 문제 4: 커스텀 집계 함수

**Q4-1.** 사용자 정의 함수를 사용하여 고급 집계를 수행하시오.

<CollapsibleCodeCell language="python" defaultCollapsed={true}>
```python
# 사용자 정의 집계 함수들
def coefficient_of_variation(series):
    """변동계수 계산"""
    return (series.std() / series.mean()) * 100

def sales_range(series):
    """매출 범위 (최대-최소)"""
    return series.max() - series.min()

def top_percentile(series, percentile=90):
    """상위 90분위수"""
    return series.quantile(percentile/100)

# 카테고리별 고급 통계
advanced_stats = df.groupby('category')['total_sales'].agg([
    'mean',
    'median',
    'std',
    coefficient_of_variation,
    sales_range,
    lambda x: top_percentile(x, 90),
    'skew'
]).round(2)

advanced_stats.columns = ['평균', '중위수', '표준편차', '변동계수(%)', '매출범위', '90분위수', '왜도']
print("카테고리별 고급 통계:")
print(advanced_stats)

# 영업사원별 성과 분석
sales_rep_performance = df.groupby('sales_rep').agg({
    'total_sales': ['sum', 'mean', 'count'],
    'customer_type': lambda x: (x == '신규').sum()  # 신규 고객 확보 수
}).round(2)

sales_rep_performance.columns = ['총매출액', '평균매출액', '주문건수', '신규고객확보수']
sales_rep_performance = sales_rep_performance.sort_values('총매출액', ascending=False)

print(f"\n영업사원별 성과 분석 (상위 10명):")
print(sales_rep_performance.head(10))

# 고성과 영업사원 식별 (상위 20%)
top_performers = sales_rep_performance.head(int(len(sales_rep_performance) * 0.2))
print(f"\n고성과 영업사원 ({len(top_performers)}명):")
print(top_performers[['총매출액', '평균매출액', '신규고객확보수']])

# 성과 분포 시각화
plt.figure(figsize=(12, 5))

plt.subplot(1, 2, 1)
plt.hist(sales_rep_performance['총매출액'], bins=15, alpha=0.7, color='skyblue', edgecolor='black')
plt.axvline(sales_rep_performance['총매출액'].mean(), color='red', linestyle='--',
           label=f'평균: {sales_rep_performance["총매출액"].mean():,.0f}')
plt.title('영업사원별 총 매출액 분포')
plt.xlabel('총 매출액')
plt.ylabel('빈도')
plt.legend()
plt.grid(True, alpha=0.3)

plt.subplot(1, 2, 2)
plt.scatter(sales_rep_performance['주문건수'], sales_rep_performance['평균매출액'], alpha=0.6)
plt.title('주문건수 vs 평균매출액')
plt.xlabel('주문건수')
plt.ylabel('평균매출액')
plt.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()
```
</CollapsibleCodeCell>

## 문제 5: 조건부 집계

**Q5-1.** 조건에 따른 집계를 수행하시오.

<CollapsibleCodeCell language="python" defaultCollapsed={true}>
```python
# 고액 주문 분석 (단위 주문 금액 상위 25%)
high_value_threshold = df['total_sales'].quantile(0.75)
print(f"고액 주문 기준: {high_value_threshold:,.0f}원 이상")

# 고액 주문 비율을 카테고리별로 계산
category_high_value = df.groupby('category').apply(
    lambda x: (x['total_sales'] >= high_value_threshold).sum() / len(x) * 100
).round(1)

print(f"\n카테고리별 고액 주문 비율:")
print(category_high_value.sort_values(ascending=False))

# 지역별 신규/기존 고객 매출 분석
region_customer_sales = df.groupby(['region', 'customer_type'])['total_sales'].agg(['sum', 'mean', 'count'])
region_customer_sales.columns = ['총매출액', '평균매출액', '주문건수']

print(f"\n지역별, 고객유형별 매출 분석:")
print(region_customer_sales.round(2))

# 신규 고객 매출 비중 계산
new_customer_ratio = df.groupby('region').apply(
    lambda x: x[x['customer_type'] == '신규']['total_sales'].sum() / x['total_sales'].sum() * 100
).round(1)

print(f"\n지역별 신규 고객 매출 비중:")
print(new_customer_ratio.sort_values(ascending=False))

# 시각화
fig, axes = plt.subplots(1, 3, figsize=(18, 5))

# 카테고리별 고액 주문 비율
category_high_value.plot(kind='bar', ax=axes[0], color='gold')
axes[0].set_title('카테고리별 고액 주문 비율 (%)')
axes[0].set_xlabel('카테고리')
axes[0].set_ylabel('고액 주문 비율 (%)')
axes[0].tick_params(axis='x', rotation=45)

# 지역별 신규 고객 매출 비중
new_customer_ratio.plot(kind='bar', ax=axes[1], color='lightgreen')
axes[1].set_title('지역별 신규 고객 매출 비중 (%)')
axes[1].set_xlabel('지역')
axes[1].set_ylabel('신규 고객 매출 비중 (%)')

# 고객 유형별 평균 주문 금액
customer_avg = df.groupby('customer_type')['total_sales'].mean()
customer_avg.plot(kind='bar', ax=axes[2], color=['coral', 'lightblue'])
axes[2].set_title('고객 유형별 평균 주문 금액')
axes[2].set_xlabel('고객 유형')
axes[2].set_ylabel('평균 주문 금액')
axes[2].tick_params(axis='x', rotation=0)

plt.tight_layout()
plt.show()
```
</CollapsibleCodeCell>

## 문제 6: transform()과 apply() 활용

**Q6-1.** transform()과 apply()를 사용하여 그룹 내 변환을 수행하시오.

<CollapsibleCodeCell language="python" defaultCollapsed={true}>
```python
# transform()을 사용한 그룹 내 표준화
df['sales_zscore_by_category'] = df.groupby('category')['total_sales'].transform(
    lambda x: (x - x.mean()) / x.std()
)

# 카테고리별 매출 순위
df['sales_rank_by_category'] = df.groupby('category')['total_sales'].rank(ascending=False)

# 지역별 매출 순위
df['sales_rank_by_region'] = df.groupby('region')['total_sales'].rank(ascending=False)

# 결과 확인
analysis_cols = ['category', 'region', 'total_sales', 'sales_zscore_by_category',
                'sales_rank_by_category', 'sales_rank_by_region']
print("그룹별 변환 결과 (상위 10개):")
print(df.nlargest(10, 'total_sales')[analysis_cols].round(2))

# 각 카테고리별 최고 매출 주문 찾기
top_sales_by_category = df.loc[df.groupby('category')['total_sales'].idxmax()]
print(f"\n카테고리별 최고 매출 주문:")
print(top_sales_by_category[['category', 'region', 'total_sales', 'sales_rep']].round(2))

# 지역별 평균보다 높은 매출을 기록한 주문 비율
df['above_region_avg'] = df.groupby('region')['total_sales'].transform(
    lambda x: x > x.mean()
)

region_above_avg_ratio = df.groupby('region')['above_region_avg'].mean() * 100
print(f"\n지역별 평균 이상 매출 주문 비율:")
print(region_above_avg_ratio.round(1))

# apply()를 사용한 복잡한 그룹 분석
def analyze_group(group):
    """그룹별 상세 분석 함수"""
    return pd.Series({
        '주문건수': len(group),
        '총매출액': group['total_sales'].sum(),
        '평균매출액': group['total_sales'].mean(),
        '매출표준편차': group['total_sales'].std(),
        '최고매출액': group['total_sales'].max(),
        '최저매출액': group['total_sales'].min(),
        '신규고객비율': (group['customer_type'] == '신규').mean() * 100
    })

category_analysis = df.groupby('category').apply(analyze_group).round(2)
print(f"\n카테고리별 상세 분석:")
print(category_analysis)

# 시각화
plt.figure(figsize=(15, 5))

plt.subplot(1, 3, 1)
df.boxplot(column='sales_zscore_by_category', by='category', ax=plt.gca())
plt.title('카테고리별 매출 Z-score 분포')
plt.suptitle('')  # 기본 제목 제거

plt.subplot(1, 3, 2)
region_above_avg_ratio.plot(kind='bar', color='lightcoral')
plt.title('지역별 평균 이상 매출 주문 비율 (%)')
plt.xlabel('지역')
plt.ylabel('비율 (%)')
plt.tick_params(axis='x', rotation=45)

plt.subplot(1, 3, 3)
category_analysis['신규고객비율'].plot(kind='bar', color='lightgreen')
plt.title('카테고리별 신규 고객 비율 (%)')
plt.xlabel('카테고리')
plt.ylabel('신규 고객 비율 (%)')
plt.tick_params(axis='x', rotation=45)

plt.tight_layout()
plt.show()
```
</CollapsibleCodeCell>

## 종합 정리

:::note[학습 요약]
이 예제에서 다룬 주요 내용:

1. **기본 GroupBy**: 단일/다중 컬럼으로 그룹화
2. **집계 함수**: sum(), mean(), count(), agg() 활용
3. **다중 그룹화**: 여러 컬럼으로 동시 그룹화
4. **시간별 집계**: 날짜/시간 데이터 그룹화
5. **커스텀 함수**: 사용자 정의 집계 함수 작성
6. **조건부 집계**: 조건에 따른 선택적 집계
7. **transform()**: 그룹별 변환 및 표준화
8. **apply()**: 복잡한 그룹별 분석 함수 적용
:::

:::warning[GroupBy 주의사항]
- **메모리 사용량**: 대용량 데이터에서 그룹화 시 메모리 고려
- **인덱스 처리**: 그룹화 결과의 인덱스 구조 이해 필요
- **NaN 처리**: 결측값이 그룹화에 미치는 영향 고려
- **성능 최적화**: 적절한 집계 함수 선택으로 성능 향상
:::

## 참고자료

- Pandas 공식 문서 - Group By
- 『파이썬 라이브러리를 활용한 데이터 분석』, 웨스 맥키니
- 『Effective Pandas』, Matt Harrison