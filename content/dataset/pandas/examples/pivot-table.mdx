# Pandas 예제문제 3 - 피벗 테이블

## 문제 설명

피벗 테이블을 활용하여 데이터를 다차원으로 분석하고 요약하는 방법을 학습하시오.

## 데이터 준비

```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# 매장별 판매 데이터 생성
np.random.seed(42)
n = 1000

# 기준 데이터 정의
stores = ['강남점', '홍대점', '신촌점', '이태원점', '명동점']
products = ['스마트폰', '태블릿', '노트북', '스마트워치', '이어폰']
brands = ['Apple', 'Samsung', 'LG', 'Sony', 'Microsoft']
quarters = ['Q1', 'Q2', 'Q3', 'Q4']
months = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월']

data = {
    'store': np.random.choice(stores, n),
    'product': np.random.choice(products, n),
    'brand': np.random.choice(brands, n),
    'quarter': np.random.choice(quarters, n),
    'month': np.random.choice(months, n),
    'sales_amount': np.random.uniform(100, 5000, n).round(2),
    'quantity': np.random.randint(1, 50, n),
    'cost': np.random.uniform(50, 3000, n).round(2),
    'customer_satisfaction': np.random.uniform(3.0, 5.0, n).round(1),
    'sales_rep': np.random.choice([f'직원{i+1}' for i in range(15)], n)
}

# 이익 계산
data['profit'] = data['sales_amount'] - data['cost']

df = pd.DataFrame(data)
print("데이터 기본정보:")
print(df.head())
print(f"\n데이터 크기: {df.shape}")
print(f"\n기본 통계:")
print(df.describe())
```

## 문제 1: 기본 피벗 테이블

**Q1-1.** 매장별, 제품별 총 매출액을 피벗 테이블로 작성하시오.

<CollapsibleCodeCell code={`print(f"\n최고 매출 조합: {max_sales_idx[0]} - {max_sales_idx[1]} ({max_sales_value:,.0f}원)")`} />

**Q1-2.** 브랜드별, 분기별 평균 고객만족도를 분석하시오.

<CollapsibleCodeCell code={`plt.show()`} />

## 문제 2: 다중 집계 함수

**Q2-1.** 여러 집계 함수를 동시에 적용한 피벗 테이블을 작성하시오.

<CollapsibleCodeCell code={`plt.show()`} />

## 문제 3: 다차원 피벗 테이블

**Q3-1.** 3개 이상의 차원을 가진 피벗 테이블을 작성하시오.

<CollapsibleCodeCell code={`plt.show()`} />

## 문제 4: 피벗 테이블 변형과 언피벗

**Q4-1.** 피벗 테이블을 다양한 형태로 변형하고 언피벗을 수행하시오.

<CollapsibleCodeCell code={`print(melted_stats.round(2))`} />

## 문제 5: 고급 피벗 분석

**Q5-1.** 조건부 집계와 커스텀 함수를 활용한 고급 피벗 분석을 수행하시오.

<CollapsibleCodeCell code={`print(f"최고 수익률 제품: {product_profitability['수익률(%)'].idxmax()}")`} />

## 종합 정리

:::note[학습 요약]
이 예제에서 다룬 주요 내용:

1. **기본 피벗 테이블**: values, index, columns, aggfunc 활용
2. **다중 집계**: 여러 집계 함수 동시 적용
3. **다차원 분석**: 3개 이상 차원으로 데이터 분석
4. **피벗 변형**: 비율 변환, 순위, 누적 합계
5. **언피벗(melt)**: 피벗 테이블을 긴 형태로 변환
6. **고급 분석**: 커스텀 함수와 조건부 집계
7. **성과 분석**: 다양한 KPI를 활용한 종합 분석
8. **시각화**: 히트맵, 산점도, 박스플롯 등 다양한 차트
:::

:::warning[피벗 테이블 주의사항]
- **메모리 사용량**: 차원이 많을수록 메모리 사용량 증가
- **결측값 처리**: fill_value 옵션으로 적절한 기본값 설정
- **데이터 타입**: 집계 함수에 적합한 데이터 타입 확인
- **인덱스 구조**: 다중 인덱스 결과 해석 주의
- **성능 최적화**: 대용량 데이터에서는 적절한 샘플링 고려
:::

## 참고자료

- Pandas 공식 문서 - Pivot Tables
- 『파이썬 라이브러리를 활용한 데이터 분석』, 웨스 맥키니
- 『Python for Data Analysis』, Wes McKinney